- id: master_bath_outlet
  alias: Turn Off the Master Bathroom Outlet
  initial_state: 'on'
  trigger:
  - platform: state
    entity_id: binary_sensor.master_bath_motion
    to: 'off'
    for: '01:00:00'
  - platform: state
    entity_id: binary_sensor.presence_melissa
    to: 'off'
  action:
  - service: switch.turn_off
    entity_id: switch.master_bath_outlet


- id: master_bath_light_on
  alias: Master Bathroom Light On
  initial_state: 'off'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: light.master_bath
      state: 'off'
    - condition: state
      entity_id: light.master_toilet
      state: 'off'
    - condition: template
      value_template: '{{ states.sensor.master_bath_luminance_statistics.attributes.min_value < 10 }}'
  trigger:
  - platform: state 
    entity_id: binary_sensor.master_bath_motion
    to: 'on'
  action:
  - service: light.turn_on
    data_template:
      brightness_pct: "{% if is_state('binary_sensor.master_in_bed', 'on') %}20{% else %}100{% endif %}"
      entity_id: "{% if is_state('binary_sensor.master_in_bed', 'on') %}light.master_toilet{% else %}light.master_bath{% endif %}"


- id: master_bath_light_off
  alias: Master Bathroom Light Off
  initial_state: 'off'
  trigger:
  - platform: state
    entity_id: binary_sensor.master_bath_motion
    to: 'off'
    for: '00:10:00'
  - platform: template
    value_template: '{{ states.sensor.master_bath_humidity.state|float < (states.sensor.master_bath_humidity_median.state|float + 5) }}'
  - platform: state
    entity_id: light.master_bath, light.master_toilet
    to: 'on'
    for: '00:10:00'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: binary_sensor.master_bath_motion
      state: 'off'
      for: '00:10:00'
    - condition: template
      value_template: '{{ states.sensor.master_bath_humidity.state|float < (states.sensor.master_bath_humidity_median.state|float + 5) }}'
  action:
  - service: light.turn_off
    entity_id:
    - light.master_bath
    - light.master_toilet


- id: master_bath_fan_on
  alias: Master Bathroom Fan On
  initial_state: 'off'
  trigger:
  - platform: template
    value_template: '{{ states.sensor.master_bath_humidity.state|float > (states.sensor.master_bath_humidity_median.state|float + 5) }}'
  action:
  - service: switch.turn_on
    entity_id: switch.master_bath_fan


- id: master_bath_fan_off
  alias: Master Bathroom Fan Off
  initial_state: 'off'
  trigger:
  - platform: state
    entity_id: binary_sensor.master_bath_motion
    to: 'off'
    for: '00:08:00'
  - platform: template
    value_template: '{{ states.sensor.master_bath_humidity.state|float < (states.sensor.master_bath_humidity_median.state|float + 5) }}'
  - platform: state
    entity_id: switch.master_bath_fan
    to: 'on'
    for: '00:08:00'
  condition:
    condition: and
    conditions:
    - condition: state
      entity_id: binary_sensor.master_bath_motion
      state: 'off'
      for: '00:08:00'
    - condition: template
      value_template: '{{ states.sensor.master_bath_humidity.state|float < (states.sensor.master_bath_humidity_median.state|float + 5) }}'
  action:
  - service: switch.turn_off
    entity_id: switch.master_bath_fan


